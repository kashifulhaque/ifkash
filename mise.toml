[tools]
bun = "latest"
node = "lts"
rust = "stable"
typst = "latest"
wrangler = "latest"

[tasks."api:prep"]
dir = "api"
description = "Install wasm target + worker-build for Cloudflare Rust Workers"
run = """
rustup target add wasm32-unknown-unknown
cargo install -q worker-build
"""

[tasks."api:build"]
dir = "api"
depends = ["api:prep"]
description = "Build the Worker (release) using worker-build"
run = "worker-build --release"

[tasks."api:dev"]
dir = "api"
depends = ["api:prep"]
description = "Run the Worker locally with wrangler + Miniflare (KV persisted)"
run = "npx wrangler dev --persist-to .wrangler/state"

[tasks."api:clean"]
dir = "api"
description = "Delete local Miniflare state (KV, caches, etc.)"
run = "rm -rf .wrangler/state"

[tasks."web:dev"]
description = "Run the SvelteKit app locally"
run = """
bun install
bun run dev
"""

[tasks."assets:fonts"]
description = "Download fonts (Crimson Pro, Cardo) directly from Google Fonts GitHub"
run = """
mkdir -p .fonts

# Crimson Pro (Variable Font: supports all weights)
# We download both Roman and Italic styles
curl -L -o .fonts/CrimsonPro.ttf "https://github.com/google/fonts/raw/main/ofl/crimsonpro/CrimsonPro%5Bwght%5D.ttf"
curl -L -o .fonts/CrimsonPro-Italic.ttf "https://github.com/google/fonts/raw/main/ofl/crimsonpro/CrimsonPro-Italic%5Bwght%5D.ttf"

# Cardo (Static Fonts)
base_url="https://github.com/google/fonts/raw/main/ofl/cardo"
curl -L -o .fonts/Cardo-Regular.ttf "$base_url/Cardo-Regular.ttf"
curl -L -o .fonts/Cardo-Bold.ttf "$base_url/Cardo-Bold.ttf"
curl -L -o .fonts/Cardo-Italic.ttf "$base_url/Cardo-Italic.ttf"
"""
outputs = [".fonts/CrimsonPro.ttf", ".fonts/Cardo-Regular.ttf"]

[tasks."assets:typst"]
description = "Compile all .typ files in static/typst to PDF using local fonts"
depends = ["assets:fonts"]
run = """
# Iterate over all .typ files in the directory
for file in ./static/assets/*.typ; do
  echo "Compiling $file..."
  # --font-path tells Typst where to look for the fonts we just downloaded
  typst compile "$file" --font-path .fonts
done
"""


[tasks."assets:sync-resume"]
description = "Sync latest resume from PocketBase to static/assets"
run = "bun run scripts/sync-resume.ts"
